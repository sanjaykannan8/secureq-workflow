graph TD
    A["ğŸš€ SecureQ Initialization"] --> B["ğŸ“Š Database Connection"]
    B --> C["ğŸ—ƒï¸ Create header_manager Table"]
    C --> D["ğŸ§¹ Start Cleanup Thread"]
    
    %% Header Management Flow
    E["ğŸ“‹ Request Session Header"] --> F["ğŸ² Generate Random String<br/>(6 chars alpranumeric)"]
    F --> G["ğŸ·ï¸ Create Header: SQ-{random}"]
    G --> H["ğŸ” Check Uniqueness in DB"]
    H --> I{Header Exists?}
    I -->|Yes| F
    I -->|No| J["ğŸ’¾ Store Header + Timestamp"]
    J --> K["âœ… Return Header to Client"]
    
    %% Background Cleanup
    D --> L["â° Every 10 Minutes"]
    L --> M["ğŸ—‘ï¸ Delete Headers > 10min old"]
    M --> N["ğŸ’¾ Commit Cleanup"]
    N --> L
    
    %% Role Creation Flow
    O["ğŸ” Create Restricted Role"] --> P["ğŸ“ Role: app_reader<br/>Table: users<br/>Restrict: ['password']"]
    P --> Q["ğŸ” Check Role Exists"]
    Q --> R{Role Exists?}
    R -->|Yes| S["âŒ Role Creation Failed"]
    R -->|No| T["ğŸ“‹ Get All Table Columns"]
    T --> U["ğŸš« Calculate Allowed Columns<br/>(All - Restricted)"]
    U --> V["ğŸ‘¤ CREATE ROLE with LOGIN"]
    V --> W["ğŸ”’ Set Role Password"]
    W --> X["ğŸ“Š CREATE VIEW pview<br/>(Allowed columns only)"]
    X --> Y["ğŸš« REVOKE ALL on Original Table"]
    Y --> Z["âœ… GRANT SELECT on pview"]
    Z --> AA["âœ… Role Created Successfully"]
    
    %% Query Security Flow
    BB["ğŸ”’ Secure Query Execution"] --> CC["ğŸ“ Template Query:<br/>SELECT name FROM users WHERE id = 1"]
    CC --> DD["ğŸ“ Actual Query:<br/>SELECT name FROM users WHERE id = 42"]
    DD --> EE["ğŸ” Generate Template Fingerprint"]
    EE --> FF["ğŸ”¤ Parse SQL with sqlglot AST"]
    FF --> GG["ğŸ¯ Map Nodes to Characters:<br/>k=keywords, l=literals, t=tables<br/>c=columns, o=operators, etc."]
    GG --> HH["ğŸ” Template Fingerprint: 'kctcol'"]
    
    DD --> II["ğŸ” Generate Actual Fingerprint"]
    II --> JJ["ğŸ”¤ Parse SQL with sqlglot AST"]
    JJ --> KK["ğŸ¯ Map Nodes to Characters"]
    KK --> LL["ğŸ” Actual Fingerprint: 'kctcol'"]
    
    HH --> MM{Fingerprints Match?}
    LL --> MM
    MM -->|No| NN["ğŸš¨ SECURITY VIOLATION<br/>Query structure mismatch"]
    MM -->|Yes| OO["ğŸ” Connect with Restricted Role"]
    OO --> PP["ğŸ“Š Execute Query on pview"]
    PP --> QQ["âœ… Return Results Securely"]
    
    NN --> RR["ğŸ“ Log Security Event"]
    RR --> SS["âŒ Reject Query"]
    
    %% Security Layers
    subgraph "ğŸ›¡ï¸ Security Layers"
        TT["1ï¸âƒ£ Connection Layer<br/>PostgreSQL Authentication"]
        UU["2ï¸âƒ£ Session Layer<br/>Time-based Headers"]
        VV["3ï¸âƒ£ Authorization Layer<br/>Role-based Access"]
        WW["4ï¸âƒ£ Query Layer<br/>SQL Fingerprinting"]
        XX["5ï¸âƒ£ Execution Layer<br/>Minimal Privileges"]
    end
    
    %% Fingerprint Character Mapping
    subgraph "ğŸ”¤ Fingerprint Mapping"
        YY["k = Keywords (SELECT, WHERE, JOIN)"]
        ZZ["l = Literals (values, numbers, NULL)"]
        AAA["t = Table references"]
        BBB["c = Column references"]
        CCC["i = Identifiers (aliases)"]
        DDD["o = Operators (=, >, AND, OR)"]
        EEE["f = Functions (COUNT, SUM)"]
        FFF["s = Structural (parentheses)"]
    end
    
    %% Risk Mitigation
    subgraph "ğŸš¨ Threat Prevention"
        GGG["SQL Injection âœ Fingerprint Validation"]
        HHH["Privilege Escalation âœ Role Isolation"]
        III["Data Exposure âœ Column Restrictions"]
        JJJ["Session Hijacking âœ Time Expiration"]
    end

    style A fill:#e1f5fe
    style BB fill:#f3e5f5
    style O fill:#e8f5e8
    style E fill:#fff3e0
    style NN fill:#ffebee
    style QQ fill:#e8f5e8 