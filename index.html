<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureQ - Database Security Module</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.9.1/dist/mermaid.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 60px 40px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header h1 {
            font-size: 3.5em;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .header p {
            font-size: 1.3em;
            position: relative;
            z-index: 1;
            opacity: 0.9;
        }

        .diagram-container {
            background-color: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 30px;
            border: 1px solid #e9ecef;
            text-align: center;
        }

        .info-box {
            background: linear-gradient(135deg, #e7f3ff, #f0f8ff);
            border: 1px solid #bee5eb;
            border-radius: 10px;
            padding: 25px;
            margin: 25px 30px;
            border-left: 5px solid #3498db;
        }

        .info-box h4 {
            margin-top: 0;
            color: #0c5460;
            font-size: 1.3em;
        }

        #mermaid-diagram {
            min-height: 600px;
            width: 100%;
        }

        .footer {
            background-color: #2c3e50;
            color: white;
            text-align: center;
            padding: 30px;
            margin-top: 60px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2.5em;
            }
            
            .diagram-container {
                padding: 15px;
                margin: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>üõ°Ô∏è SecureQ</h1>
            <p>Advanced PostgreSQL Security Module with Multi-Layer Protection</p>
        </header>

        <main>
            <div class="info-box">
                <h4>üìä SecureQ Security Workflow</h4>
                <p>This diagram illustrates the complete security architecture of SecureQ, showing how multiple security layers work together to provide secure database access with advanced query validation and role-based permissions.</p>
            </div>

            <div class="diagram-container">
                <div id="mermaid-diagram">
                    <div class="mermaid">
flowchart TD
    A["SecureQ Initialization"] --> B["Database Connection"]
    B --> C["Create header_manager Table"]
    C --> D["Start Cleanup Thread"]
    
    E["Request Session Header"] --> F["Generate Random String"]
    F --> G["Create Header: SQ-random"]
    G --> H["Check Uniqueness in DB"]
    H --> I{Header Exists?}
    I -->|Yes| F
    I -->|No| J["Store Header + Timestamp"]
    J --> K["Return Header to Client"]
    
    D --> L["Every 10 Minutes"]
    L --> M["Delete Headers older than 10min"]
    M --> N["Commit Cleanup"]
    N --> L
    
    O["Create Restricted Role"] --> P["Role Definition<br/>Table: users<br/>Restrict: password"]
    P --> Q["Check Role Exists"]
    Q --> R{Role Exists?}
    R -->|Yes| S["Role Creation Failed"]
    R -->|No| T["Get All Table Columns"]
    T --> U["Calculate Allowed Columns"]
    U --> V["CREATE ROLE with LOGIN"]
    V --> W["Set Role Password"]
    W --> X["CREATE VIEW pview"]
    X --> Y["REVOKE ALL on Original Table"]
    Y --> Z["GRANT SELECT on pview"]
    Z --> AA["Role Created Successfully"]
    
    BB["Secure Query Execution"] --> CC["Template Query<br/>SELECT name FROM users WHERE id = 1"]
    CC --> DD["Actual Query<br/>SELECT name FROM users WHERE id = 42"]
    DD --> EE["Generate Template Fingerprint"]
    EE --> FF["Parse SQL with sqlglot AST"]
    FF --> GG["Map Nodes to Characters<br/>k=keywords, l=literals, t=tables"]
    GG --> HH["Template Fingerprint: kctcol"]
    
    DD --> II["Generate Actual Fingerprint"]
    II --> JJ["Parse SQL with sqlglot AST"]
    JJ --> KK["Map Nodes to Characters"]
    KK --> LL["Actual Fingerprint: kctcol"]
    
    HH --> MM{Fingerprints Match?}
    LL --> MM
    MM -->|No| NN["SECURITY VIOLATION<br/>Query structure mismatch"]
    MM -->|Yes| OO["Connect with Restricted Role"]
    OO --> PP["Execute Query on pview"]
    PP --> QQ["Return Results Securely"]
    
    NN --> RR["Log Security Event"]
    RR --> SS["Reject Query"]
    
    subgraph "Security Layers"
        TT["1. Connection Layer<br/>PostgreSQL Authentication"]
        UU["2. Session Layer<br/>Time-based Headers"]
        VV["3. Authorization Layer<br/>Role-based Access"]
        WW["4. Query Layer<br/>SQL Fingerprinting"]
        XX["5. Execution Layer<br/>Minimal Privileges"]
    end
    
    subgraph "Fingerprint Mapping"
        YY["k = Keywords SELECT WHERE JOIN"]
        ZZ["l = Literals values numbers NULL"]
        AAA["t = Table references"]
        BBB["c = Column references"]
        CCC["i = Identifiers aliases"]
        DDD["o = Operators = > < AND OR"]
        EEE["f = Functions COUNT SUM"]
        FFF["s = Structural parentheses"]
    end
    
    subgraph "Threat Prevention"
        GGG["SQL Injection ‚Üí Fingerprint Validation"]
        HHH["Privilege Escalation ‚Üí Role Isolation"]
        III["Data Exposure ‚Üí Column Restrictions"]
        JJJ["Session Hijacking ‚Üí Time Expiration"]
    end

    style A fill:#e1f5fe
    style BB fill:#f3e5f5
    style O fill:#e8f5e8
    style E fill:#fff3e0
    style NN fill:#ffebee
    style QQ fill:#e8f5e8
                    </div>
                </div>
            </div>

            <div class="info-box">
                <h4>üî§ Fingerprint Character Mapping</h4>
                <ul>
                    <li><strong>k</strong> = Keywords/Commands (SELECT, INSERT, WHERE, JOIN, FROM)</li>
                    <li><strong>l</strong> = Literals/Values (strings, numbers, NULL, *)</li>
                    <li><strong>t</strong> = Table references (users, products, orders)</li>
                    <li><strong>c</strong> = Column references (name, email, id)</li>
                    <li><strong>i</strong> = Identifiers (aliases, column names in INSERT)</li>
                    <li><strong>o</strong> = Operators (=, >, <, AND, OR, NOT)</li>
                    <li><strong>f</strong> = Functions (COUNT, SUM, AVG, MIN, MAX)</li>
                    <li><strong>s</strong> = Structural elements (parentheses, brackets)</li>
                    <li><strong>u</strong> = UPDATE-specific (SET clause elements)</li>
                </ul>
            </div>

            <div class="info-box">
                <h4>üõ°Ô∏è Security Features</h4>
                <ul>
                    <li><strong>SQL Fingerprinting:</strong> Advanced query structure validation using AST parsing</li>
                    <li><strong>Role-Based Access Control:</strong> Granular permission management with restricted views</li>
                    <li><strong>Header Management:</strong> Time-based session tokens with automatic cleanup</li>
                    <li><strong>Query Validation:</strong> Structure-based query comparison to prevent injection attacks</li>
                </ul>
            </div>
        </main>

        <footer class="footer">
            <p>üõ°Ô∏è SecureQ - Advanced Database Security Module | Version 1.0 | December 2024</p>
            <p>Compatible with PostgreSQL 9.6+ and Python 3.7+</p>
        </footer>
    </div>

    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                fontFamily: 'Segoe UI, Tahoma, Geneva, Verdana, sans-serif',
                fontSize: '12px'
            }
        });
    </script>
</body>
</html> 
