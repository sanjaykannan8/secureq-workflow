<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SecureQ Workflow Diagram</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 100%;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
        }
        
        .diagram-container {
            text-align: center;
            margin: 20px 0;
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e1e1e1;
        }
        
        .export-instructions {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-top: 30px;
            border-left: 4px solid #007bff;
        }
        
        .export-instructions h3 {
            color: #007bff;
            margin-top: 0;
        }
        
        .export-instructions code {
            background-color: #e9ecef;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        
        .export-instructions ol {
            padding-left: 20px;
        }
        
        .export-instructions li {
            margin-bottom: 8px;
        }
        
        .info-box {
            background-color: #e7f3ff;
            border: 1px solid #bee5eb;
            border-radius: 5px;
            padding: 15px;
            margin: 20px 0;
        }
        
        .info-box h4 {
            margin-top: 0;
            color: #0c5460;
        }
        
        #mermaid-diagram {
            min-height: 600px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è SecureQ Security Workflow</h1>
        
        <div class="info-box">
            <h4>üìã About This Diagram</h4>
            <p>This workflow diagram illustrates the complete security architecture of the SecureQ module, showing how multiple security layers work together to provide secure database access with advanced query validation and role-based permissions.</p>
        </div>
        
        <div class="diagram-container">
            <div id="mermaid-diagram">
                <div class="mermaid">
graph TD
    A["üöÄ SecureQ Initialization"] --> B["üìä Database Connection"]
    B --> C["üóÉÔ∏è Create header_manager Table"]
    C --> D["üßπ Start Cleanup Thread"]
    
    %% Header Management Flow
    E["üìã Request Session Header"] --> F["üé≤ Generate Random String<br/>(6 chars alpranumeric)"]
    F --> G["üè∑Ô∏è Create Header: SQ-{random}"]
    G --> H["üîç Check Uniqueness in DB"]
    H --> I{Header Exists?}
    I -->|Yes| F
    I -->|No| J["üíæ Store Header + Timestamp"]
    J --> K["‚úÖ Return Header to Client"]
    
    %% Background Cleanup
    D --> L["‚è∞ Every 10 Minutes"]
    L --> M["üóëÔ∏è Delete Headers > 10min old"]
    M --> N["üíæ Commit Cleanup"]
    N --> L
    
    %% Role Creation Flow
    O["üîê Create Restricted Role"] --> P["üìù Role: app_reader<br/>Table: users<br/>Restrict: ['password']"]
    P --> Q["üîç Check Role Exists"]
    Q --> R{Role Exists?}
    R -->|Yes| S["‚ùå Role Creation Failed"]
    R -->|No| T["üìã Get All Table Columns"]
    T --> U["üö´ Calculate Allowed Columns<br/>(All - Restricted)"]
    U --> V["üë§ CREATE ROLE with LOGIN"]
    V --> W["üîí Set Role Password"]
    W --> X["üìä CREATE VIEW pview<br/>(Allowed columns only)"]
    X --> Y["üö´ REVOKE ALL on Original Table"]
    Y --> Z["‚úÖ GRANT SELECT on pview"]
    Z --> AA["‚úÖ Role Created Successfully"]
    
    %% Query Security Flow
    BB["üîí Secure Query Execution"] --> CC["üìù Template Query:<br/>SELECT name FROM users WHERE id = 1"]
    CC --> DD["üìù Actual Query:<br/>SELECT name FROM users WHERE id = 42"]
    DD --> EE["üîç Generate Template Fingerprint"]
    EE --> FF["üî§ Parse SQL with sqlglot AST"]
    FF --> GG["üéØ Map Nodes to Characters:<br/>k=keywords, l=literals, t=tables<br/>c=columns, o=operators, etc."]
    GG --> HH["üîç Template Fingerprint: 'kctcol'"]
    
    DD --> II["üîç Generate Actual Fingerprint"]
    II --> JJ["üî§ Parse SQL with sqlglot AST"]
    JJ --> KK["üéØ Map Nodes to Characters"]
    KK --> LL["üîç Actual Fingerprint: 'kctcol'"]
    
    HH --> MM{Fingerprints Match?}
    LL --> MM
    MM -->|No| NN["üö® SECURITY VIOLATION<br/>Query structure mismatch"]
    MM -->|Yes| OO["üîê Connect with Restricted Role"]
    OO --> PP["üìä Execute Query on pview"]
    PP --> QQ["‚úÖ Return Results Securely"]
    
    NN --> RR["üìù Log Security Event"]
    RR --> SS["‚ùå Reject Query"]
    
    %% Security Layers
    subgraph "üõ°Ô∏è Security Layers"
        TT["1Ô∏è‚É£ Connection Layer<br/>PostgreSQL Authentication"]
        UU["2Ô∏è‚É£ Session Layer<br/>Time-based Headers"]
        VV["3Ô∏è‚É£ Authorization Layer<br/>Role-based Access"]
        WW["4Ô∏è‚É£ Query Layer<br/>SQL Fingerprinting"]
        XX["5Ô∏è‚É£ Execution Layer<br/>Minimal Privileges"]
    end
    
    %% Fingerprint Character Mapping
    subgraph "üî§ Fingerprint Mapping"
        YY["k = Keywords (SELECT, WHERE, JOIN)"]
        ZZ["l = Literals (values, numbers, NULL)"]
        AAA["t = Table references"]
        BBB["c = Column references"]
        CCC["i = Identifiers (aliases)"]
        DDD["o = Operators (=, >, AND, OR)"]
        EEE["f = Functions (COUNT, SUM)"]
        FFF["s = Structural (parentheses)"]
    end
    
    %% Risk Mitigation
    subgraph "üö® Threat Prevention"
        GGG["SQL Injection ‚ûú Fingerprint Validation"]
        HHH["Privilege Escalation ‚ûú Role Isolation"]
        III["Data Exposure ‚ûú Column Restrictions"]
        JJJ["Session Hijacking ‚ûú Time Expiration"]
    end

    style A fill:#e1f5fe
    style BB fill:#f3e5f5
    style O fill:#e8f5e8
    style E fill:#fff3e0
    style NN fill:#ffebee
    style QQ fill:#e8f5e8
                </div>
            </div>
        </div>
        
        
        <div class="info-box">
            <h4>üìÅ Generated Files</h4>
            <p><strong>SecureQ_Workflow.mmd</strong> - Pure Mermaid diagram code<br/>
            <strong>SecureQ_Workflow.html</strong> - This interactive HTML file<br/>
            <strong>SecureQ_Documentation.md</strong> - Complete module documentation</p>
        </div>
    </div>

    <script>
        // Initialize Mermaid with custom config
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            flowchart: {
                useMaxWidth: true,
                htmlLabels: true,
                curve: 'basis'
            },
            themeVariables: {
                fontFamily: '"Segoe UI", Tahoma, Geneva, Verdana, sans-serif',
                fontSize: '14px'
            }
        });
    </script>
</body>
</html> 
